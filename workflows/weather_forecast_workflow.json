{
  "name": "Weather Forecast Weekly",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 7 * * 1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        200,
        300
      ],
      "id": "schedule-trigger",
      "name": "Cron: Monday 07:00"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:8000/predict",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"city\": \"–ú–æ—Å–∫–≤–∞\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        400,
        200
      ],
      "id": "predict-moscow",
      "name": "Predict Moscow"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:8000/predict",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"city\": \"–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        400,
        400
      ],
      "id": "predict-spb",
      "name": "Predict Saint-Petersburg"
    },
    {
      "parameters": {
        "jsCode": "// –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è –æ–±–æ–∏—Ö –≥–æ—Ä–æ–¥–æ–≤\nconst allItems = $input.all();\n\nlet moscowData = null;\nlet spbData = null;\n\nfor (const item of allItems) {\n  if (item.json.city === '–ú–æ—Å–∫–≤–∞') {\n    moscowData = item.json;\n  } else if (item.json.city === '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥') {\n    spbData = item.json;\n  }\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram\nlet message = 'üå§Ô∏è *–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã*\\n';\nmessage += `üìÖ –î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞: ${new Date().toLocaleDateString('ru-RU')}\\n\\n`;\n\nfunction formatForecast(data) {\n  if (!data || !data.forecasts) return '‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã\\n';\n  \n  let text = `üèôÔ∏è *${data.city}*\\n`;\n  \n  const weekdays = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];\n  \n  for (const forecast of data.forecasts) {\n    const date = new Date(forecast.date);\n    const weekday = weekdays[date.getDay()];\n    const dayMonth = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });\n    \n    const temp = forecast.predicted_temp_avg;\n    const lower = forecast.confidence_interval.lower;\n    const upper = forecast.confidence_interval.upper;\n    \n    // –≠–º–æ–¥–∑–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã\n    let emoji = 'üå°Ô∏è';\n    if (temp < 0) emoji = '‚ùÑÔ∏è';\n    else if (temp < 10) emoji = 'üå•Ô∏è';\n    else if (temp < 20) emoji = '‚õÖ';\n    else if (temp < 25) emoji = '‚òÄÔ∏è';\n    else emoji = 'üî•';\n    \n    text += `${emoji} ${weekday} ${dayMonth}: *${temp}¬∞C* (${lower}...${upper})\\n`;\n  }\n  \n  return text + '\\n';\n}\n\nmessage += formatForecast(moscowData);\nmessage += formatForecast(spbData);\n\nmessage += '---\\n';\nmessage += 'ü§ñ _–ü—Ä–æ–≥–Ω–æ–∑ –æ—Ç ML-–º–æ–¥–µ–ª–∏ Weather Forecast_\\n';\n\nif (moscowData && moscowData.model_version) {\n  message += `üìä –í–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏: ${moscowData.model_version}`;\n}\n\nreturn [{\n  json: {\n    message: message,\n    moscow: moscowData,\n    spb: spbData\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        300
      ],
      "id": "format-message",
      "name": "Format Message"
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        800,
        300
      ],
      "id": "send-telegram",
      "name": "Send to Telegram",
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "error-check",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        600,
        500
      ],
      "id": "check-error",
      "name": "Check Error"
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "‚ùå *–û—à–∏–±–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã*\n\n–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–∏—Å–∞.\n\n–û—à–∏–±–∫–∞: {{ $json.error }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        800,
        500
      ],
      "id": "send-error",
      "name": "Send Error to Telegram",
      "credentials": {
        "telegramApi": {
          "id": "telegram-credentials",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        500,
        300
      ],
      "id": "merge-results",
      "name": "Merge Results"
    },
    {
      "parameters": {
        "url": "http://host.docker.internal:8000/health",
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        300,
        300
      ],
      "id": "health-check",
      "name": "Health Check"
    }
  ],
  "pinData": {},
  "connections": {
    "Cron: Monday 07:00": {
      "main": [
        [
          {
            "node": "Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Health Check": {
      "main": [
        [
          {
            "node": "Predict Moscow",
            "type": "main",
            "index": 0
          },
          {
            "node": "Predict Saint-Petersburg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Predict Moscow": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Predict Saint-Petersburg": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Results": {
      "main": [
        [
          {
            "node": "Format Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Message": {
      "main": [
        [
          {
            "node": "Send to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Error": {
      "main": [
        [
          {
            "node": "Send Error to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "Europe/Moscow"
  },
  "versionId": "weather-forecast-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "weather-forecast-instance"
  },
  "id": "weather-forecast-weekly",
  "tags": [
    "weather",
    "forecast",
    "telegram"
  ]
}

